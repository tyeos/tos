//
// Created by toney on 2023-09-01.
//

#include "../include/dt.h"
#include "../include/linux/kernel.h"
#include "../include/pic_handler.h"

/*
 -----------------------------------------------------------------------------------------------------------------
 定义 IDT (Interrupt Vector Table) 描述符属性（中断描述符表中的描述符又称为门，共四种门描述符: 任务门、中断门、陷阱门、调用门）
 注：现代操作系统为了简化开发、提升性能和移植性等原因，很少用到调用门和任务门。Linux的系统调用一般也都是使用中断门。
 -----------------------------------------------------------------------------------------------------------------
 每个门描述符占8字节，其中高32位的第8~15位结构统一如下：
     -------------------------------------------------
     | 15  | 14  | 13  | 12  | 11  | 10  |  9  |  8  |
     |  P  |    DPL    |  S  |         TYPE          |
     -------------------------------------------------
 P:
     Present, 0-不存在于内存中（段异常），1-段存在于内存中
     CPU检测到P值为0时，会转到异常处理程序
     特别注意:
        GDT中的第0个段描述符是不可用的，但DT却无此限制，第0个门描述符也是可用的，中断向量号为0的中断是除法错。
        但处理器只支持256个中断，即0~254，中断描述符中其余的描述符不可用（这些可以把P位置0）。
 DPL:
     Descriptor Privilege Level, 即段描述符特权级，0~3四种特权级，数字越小特权级越大。
     用于标识访问该段的最低权限。
     一般情况下，操作系统处于最高的0特权级，用户程序处于最低的3特权级，某些指令仅在0特权级下才能执行。
 S：
    为0时表示系统段，S为1时表示数据段。
    这里的各种门都属于系统段，即S都等于0。
 TYPE:
    和S字段配合在一起才能确定段描述符的确切类型。
    系统段中的TYPE结构（S=0）：
        -----------------
        | 3 | 2 | 1 | 0 |
        ----------------- ----系统段类型---- | ----------说明----------------------------------------------
        | 0 | 0 | 0 | 0 | 未定义            | 保留
        | 0 | 0 | 0 | 1 | 可用的 80286 TSS  | 仅限286的任务状态段
        | 0 | 0 | 1 | 0 | LDT              | 局部描述符表，只有第1位为1
        | 0 | 0 | 1 | 1 | 忙碌的 80286 TSS  | 仅限286。type中的第1位称为B位，若为1，则表示当前任务忙碌。由CPU将此位置1
        | 0 | 1 | 0 | 0 | 80286 调用门      | 仅限286
        | 0 | 1 | 0 | 1 | 任务门            | 任务门在现代操作系统中很少用到
        | 0 | 1 | 1 | 0 | 80286 中断门      | 仅限286
        | 0 | 1 | 1 | 1 | 80286 陷阱门      | 仅限286
        | 1 | 0 | 0 | 0 | 未定义            | 保留
        | 1 | 0 | 0 | 1 | 可用的 80386 TSS  | 386以上CPU的TSS, type第3位为1
        | 1 | 0 | 1 | 0 | 未定义            | 保留
        | 1 | 0 | 1 | 1 | 忙碌的 80386 TSS  | 386以上CPU的TSS, type第3位为1
        | 1 | 1 | 0 | 0 | 80386 调用门      | 386以上CPU的调用门，type第3位为1
        | 1 | 1 | 0 | 1 | 未定义            | 保留
        | 1 | 1 | 1 | 0 | 中断门            | 386以上CPU的中断门
        | 1 | 1 | 1 | 1 | 陷阱门            | 386以上CPU的陷阱门
        ---------------------------------------------------------------------------------------------------

 -----------------------------------------------------------------------------------------------------------------
 任务门：
     任务门和任务状态段(Task Status Segment, TSS)是Intel处理器在硬件一级提供的任务切换机制，
     所以任务门需要和TSS配合在一起使用，在任务门中记录的是TSS选择子，偏移量未使用。
     任务门可以存在于全局描述符表GDT、局部描述符表LDT、中断描述符表IDT中。
     注：大多数操作系统（包括Linux)都未用TSS实现任务切换
 描述符格式：
     高32位：
         -------------------------------------------------------------------------------------------------
         | 31  | 30  | 29  | 28  | 27  | 26  | 25  | 24  | 23  | 22  | 21  | 20  | 19  | 18  | 17  | 16  |
         |                                             未使用                                             |
         -------------------------------------------------------------------------------------------------
         -------------------------------------------------------------------------------------------------
         | 15  | 14  | 13  | 12  | 11  | 10  |  9  |  8  |  7  |  6  |  5  |  4  |  3  |  2  |  1  |  0  |
         |  P  |    DPL    |  S  |         TYPE          |                     未使用                     |
         -------------------------------------------------------------------------------------------------
     低32位：
         -------------------------------------------------------------------------------------------------
         | 31  | 30  | 29  | 28  | 27  | 26  | 25  | 24  | 23  | 22  | 21  | 20  | 19  | 18  | 17  | 16  |
         |                                           TSS 选择子                                           |
         -------------------------------------------------------------------------------------------------
         -------------------------------------------------------------------------------------------------
         | 15  | 14  | 13  | 12  | 11  | 10  |  9  |  8  |  7  |  6  |  5  |  4  |  3  |  2  |  1  |  0  |
         |                                             未使用                                             |
         -------------------------------------------------------------------------------------------------
     S和TYPE的取值:
         -------------------------------
          ... | S |      TYPE     | ...
         -------------------------------
          ... | 0 | 0 | 1 | 0 | 1 | ...
         -------------------------------

 -----------------------------------------------------------------------------------------------------------------
 中断门:
     中断门包含了中断处理程序所在段的段选择子和段内偏移地址。
     当通过此方式进入中断后，标志寄存器eflags中的F位自动置0，也就是在进入中断后，自动把中断关闭，避免中断嵌套。
     Linux就是利用中断门实现的系统调用，就是那个著名的int 0x80。
     中断门只允许存在于IDT中。
 描述符格式：
     高32位：
         -------------------------------------------------------------------------------------------------
         | 31  | 30  | 29  | 28  | 27  | 26  | 25  | 24  | 23  | 22  | 21  | 20  | 19  | 18  | 17  | 16  |
         |                             中断处理程序在目标代码段内的偏移量的16~31位                              |
         -------------------------------------------------------------------------------------------------
         -------------------------------------------------------------------------------------------------
         | 15  | 14  | 13  | 12  | 11  | 10  |  9  |  8  |  7  |  6  |  5  |  4  |  3  |  2  |  1  |  0  |
         |  P  |    DPL    |  S  |         TYPE          |                     未使用                     |
         -------------------------------------------------------------------------------------------------
     低32位：
         -------------------------------------------------------------------------------------------------
         | 31  | 30  | 29  | 28  | 27  | 26  | 25  | 24  | 23  | 22  | 21  | 20  | 19  | 18  | 17  | 16  |
         |                                  中断处理程序目标代码段描述符选择子                                  |
         -------------------------------------------------------------------------------------------------
         -------------------------------------------------------------------------------------------------
         | 15  | 14  | 13  | 12  | 11  | 10  |  9  |  8  |  7  |  6  |  5  |  4  |  3  |  2  |  1  |  0  |
         |                               中断处理程序在目标代码段内的偏移量的0~15位                              |
         -------------------------------------------------------------------------------------------------
 S和TYPE的取值:
   -------------------------------
    ... | S |      TYPE     | ...
   -------------------------------
    ... | 0 | D | 1 | 1 | 0 | ...
   -------------------------------
   D: D位为0表示16位模式, D位为1表示32位模式

 -----------------------------------------------------------------------------------------------------------------
 陷阱门：
     陷阱门和中断门非常相似，区别是由陷阱门进入中断后，标志寄存器eflags中的F位不会自动置0。
     陷阱门只允许存在于DT中。
 描述符格式：
     高32位：
         -------------------------------------------------------------------------------------------------
         | 31  | 30  | 29  | 28  | 27  | 26  | 25  | 24  | 23  | 22  | 21  | 20  | 19  | 18  | 17  | 16  |
         |                             中断处理程序在目标代码段内的偏移量的16~31位                              |
         -------------------------------------------------------------------------------------------------
         -------------------------------------------------------------------------------------------------
         | 15  | 14  | 13  | 12  | 11  | 10  |  9  |  8  |  7  |  6  |  5  |  4  |  3  |  2  |  1  |  0  |
         |  P  |    DPL    |  S  |         TYPE          |                     未使用                     |
         -------------------------------------------------------------------------------------------------
     低32位：
         -------------------------------------------------------------------------------------------------
         | 31  | 30  | 29  | 28  | 27  | 26  | 25  | 24  | 23  | 22  | 21  | 20  | 19  | 18  | 17  | 16  |
         |                                  中断处理程序目标代码段描述符选择子                                  |
         -------------------------------------------------------------------------------------------------
         -------------------------------------------------------------------------------------------------
         | 15  | 14  | 13  | 12  | 11  | 10  |  9  |  8  |  7  |  6  |  5  |  4  |  3  |  2  |  1  |  0  |
         |                               中断处理程序在目标代码段内的偏移量的0~15位                              |
         -------------------------------------------------------------------------------------------------
 S和TYPE的取值:
   -------------------------------
    ... | S |      TYPE     | ...
   -------------------------------
    ... | 0 | D | 1 | 1 | 1 | ...
   -------------------------------
   D: D位为0表示16位模式, D位为1表示32位模式

 -----------------------------------------------------------------------------------------------------------------
 调用门：
     调用门是提供给用户进程进入特权0级的方式，其DPL为3。
     调用门中记录例程的地址，它不能用int指令调用，只能用call和jmp指令。
     调用门可以安装在GDT和LDT中。
 描述符格式：
     高32位：
         -------------------------------------------------------------------------------------------------
         | 31  | 30  | 29  | 28  | 27  | 26  | 25  | 24  | 23  | 22  | 21  | 20  | 19  | 18  | 17  | 16  |
         |                             被调用例程在目标代码段内的偏移量的16~31位                                |
         -------------------------------------------------------------------------------------------------
         -------------------------------------------------------------------------------------------------
         | 15  | 14  | 13  | 12  | 11  | 10  |  9  |  8  |  7  |  6  |  5  |  4  |  3  |  2  |  1  |  0  |
         |  P  |    DPL    |  S  |         TYPE          |  0  |  0  |  0  |        参数个数               |
         -------------------------------------------------------------------------------------------------
     低32位：
         -------------------------------------------------------------------------------------------------
         | 31  | 30  | 29  | 28  | 27  | 26  | 25  | 24  | 23  | 22  | 21  | 20  | 19  | 18  | 17  | 16  |
         |                                  被调用例程所在代码段的描述符选择子                                  |
         -------------------------------------------------------------------------------------------------
         -------------------------------------------------------------------------------------------------
         | 15  | 14  | 13  | 12  | 11  | 10  |  9  |  8  |  7  |  6  |  5  |  4  |  3  |  2  |  1  |  0  |
         |                               被调用例程在目标代码段内的偏移量的0~15位                               |
         -------------------------------------------------------------------------------------------------
 S和TYPE的取值:
   -------------------------------
    ... | S |      TYPE     | ...
   -------------------------------
    ... | 0 | D | 1 | 0 | 0 | ...
   -------------------------------
   D: D位为0表示16位模式, D位为1表示32位模式

 -----------------------------------------------------------------------------------------------------------------
*/
#define IDT_SIZE    256
interrupt_gate idt[IDT_SIZE] = {0};

/*
 -----------------------------------------------------------------------------------------------------------------
 中断描述符表寄存器（Interrupt Descriptor Table Register, IDTR）结构：
     -------------------------------------------------------------------------------
     | 47  |  ...    ...    ...    ...    ...  |  16  |    15  |  ...   ...  |  0  |
     |                  32位的表基址                    |          16位的表界限        |
     -------------------------------------------------------------------------------
     16位的表界限表示最大范围是0xFFFF，即64KB。可容纳的描述符个数是64KB/8=8K=8192个。

 加载IDTR指令：
     lidt 48位内存数据
 -----------------------------------------------------------------------------------------------------------------
*/
dt_ptr idt_ptr;

extern int interrupt_handler_table[0x2f]; // 地址在汇编中定义

void idt_init() {

    for (int i = 0; i < IDT_SIZE; ++i) {
        interrupt_gate *p = &idt[i];

        int handler = interrupt_handler_table[i];

        p->offset0 = handler & 0xffff;
        p->offset1 = (handler >> 16) & 0xffff; // 设置中断处理函数

        p->selector = 1 << 3; // 代码段 （TI=0,RPL=0,即对应GDT表index=1的段）
        p->reserved = 0;      // 保留不用
        p->type = 0b1110;     // 中断门
        p->segment = 0;       // 系统段
        p->DPL = 0;           // 内核态
        p->present = 1;       // 有效
    }

    // 让CPU知道中断向量表
    idt_ptr.limit = IDT_SIZE * 8;
    idt_ptr.base = (int) idt;
    __asm__ volatile("lidt idt_ptr;");
}

// 从汇编中回调
void interrupt_handler_callback(int idt_index, int edi, int esi, int ebp, int esp, int ebx, int edx, int ecx, int eax, int eip, char cs, int eflags) {
    // 由可编程中断控制芯片触发
    if (idt_index >= 0x20 && idt_index < 0x30) {
        interrupt_handler_pic(idt_index, edi, esi, ebp, esp, ebx, edx, ecx, eax, eip, cs, eflags);
        return;
    }
    // 其他中断，基本都称之为异常
    printk("\n============================\n");
    printk("INTERRUPT : \n");
    printk("   VECTOR : 0x%02X\n", idt_index);
    printk("   EFLAGS : 0x%08X\n", eflags);
    printk("       CS : 0x%02X\n", cs);
    printk("      EIP : 0x%08X\n", eip);
    printk("      ESP : 0x%08X\n", esp);
    printk("============================\n");
}